name: Cross Compile and Deploy for OpenWrt

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - aarch64-unknown-linux-gnu    # GNU libc ç‰ˆæœ¬
          - aarch64-unknown-linux-musl   # MUSL libc é™æ€é“¾æ¥ç‰ˆæœ¬
          - armv7-unknown-linux-gnueabihf
          - x86_64-unknown-linux-gnu
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}
    
    - name: Install cross-compilation tools
      run: |
        sudo apt-get update
        if [[ "${{ matrix.target }}" == "aarch64-unknown-linux-gnu" ]]; then
          sudo apt-get install -y gcc-aarch64-linux-gnu libc6-dev-arm64-cross
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
        elif [[ "${{ matrix.target }}" == "aarch64-unknown-linux-musl" ]]; then
          sudo apt-get install -y gcc-aarch64-linux-gnu musl-tools
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "CC_aarch64_unknown_linux_musl=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "RUSTFLAGS=-C target-feature=+crt-static" >> $GITHUB_ENV
        elif [[ "${{ matrix.target }}" == "armv7-unknown-linux-gnueabihf" ]]; then
          sudo apt-get install -y gcc-arm-linux-gnueabihf libc6-dev-armhf-cross
          echo "CARGO_TARGET_ARMV7_UNKNOWN_LINUX_GNUEABIHF_LINKER=arm-linux-gnueabihf-gcc" >> $GITHUB_ENV
          echo "CC_armv7_unknown_linux_gnueabihf=arm-linux-gnueabihf-gcc" >> $GITHUB_ENV
        fi
    
    - name: Build
      run: |
        cargo build --release --target ${{ matrix.target }}
        ls -lh target/${{ matrix.target }}/release/websocket-at-gateway
        file target/${{ matrix.target }}/release/websocket-at-gateway
    - name: Ensure packaging scripts executable
      run: |
        chmod +x openwrt/scripts/make-ipk.sh
        chmod +x openwrt/init.d/websocket-at-gateway
    - name: Build IPK
      run: |
        case "${{ matrix.target }}" in
          aarch64-unknown-linux-musl|aarch64-unknown-linux-gnu) OW_ARCH="aarch64" ;;
          armv7-unknown-linux-gnueabihf) OW_ARCH="armv7" ;;
          x86_64-unknown-linux-gnu) OW_ARCH="x86_64" ;;
        esac
        VERSION=$(sed -n 's/^version\s*=\s*"\([^"]\+\)"/\1/p' Cargo.toml | head -n1)
        BIN="target/${{ matrix.target }}/release/websocket-at-gateway"
        OUTDIR="ipk"
        ARCH="$OW_ARCH" VERSION="$VERSION" RELEASE="$GITHUB_RUN_NUMBER" BIN="$BIN" OUTDIR="$OUTDIR" ./openwrt/scripts/make-ipk.sh
    - name: Upload IPK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ipk-${{ matrix.target }}
        path: ipk/*.ipk
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: websocket-at-gateway-${{ matrix.target }}
        path: target/${{ matrix.target }}/release/websocket-at-gateway
    
    - name: Create release archive
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        cd target/${{ matrix.target }}/release
        tar -czf websocket-at-gateway-${{ matrix.target }}.tar.gz websocket-at-gateway
        cd -
        mv target/${{ matrix.target }}/release/websocket-at-gateway-${{ matrix.target }}.tar.gz .
    
    - name: Upload release artifact
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: websocket-at-gateway-${{ matrix.target }}-release
        path: websocket-at-gateway-${{ matrix.target }}.tar.gz

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: websocket-at-gateway-*-release
        path: artifacts
    - name: Download IPK artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: ipk-*
        path: artifacts
    
    - name: Display structure of downloaded files
      run: ls -R artifacts
    
    - name: Get commit info
      id: commit_info
      run: |
        echo "COMMIT_TIME=$(git show -s --format=%ci ${{ github.sha }})" >> $GITHUB_OUTPUT
        echo "COMMIT_MESSAGE=$(git show -s --format=%s ${{ github.sha }})" >> $GITHUB_OUTPUT
        echo "COMMIT_AUTHOR=$(git show -s --format=%an ${{ github.sha }})" >> $GITHUB_OUTPUT
    
    - name: Collect IPK file paths
      id: collect_ipk
      run: |
        echo "files<<EOF" >> $GITHUB_OUTPUT
        find artifacts -type f -name '*.ipk'
        echo "EOF" >> $GITHUB_OUTPUT
    - name: Create Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }}
        draft: false
        prerelease: false
        body: |
          WebSocket AT Gateway è‡ªåŠ¨æ„å»ºç‰ˆæœ¬
          
          ğŸ“… æ„å»ºæ—¶é—´: ${{ steps.commit_info.outputs.COMMIT_TIME }}
          ğŸ“ æäº¤ä¿¡æ¯: ${{ steps.commit_info.outputs.COMMIT_MESSAGE }}
          ğŸ‘¤ æäº¤è€…: ${{ steps.commit_info.outputs.COMMIT_AUTHOR }}
          ğŸ”¢ è¿è¡Œç¼–å·: #${{ github.run_number }}
          
          ## ğŸ“¦ åŒ…å«æ¶æ„
          - **aarch64-unknown-linux-musl** (ARM64 é™æ€é“¾æ¥, æ¨èç”¨äºOpenWRT)
          - **aarch64-unknown-linux-gnu** (ARM64 GNU libc, é€‚åˆæ ‡å‡†Linuxç³»ç»Ÿ)
          - **armv7-unknown-linux-gnueabihf** (ARMv7, é€‚åˆè€ARMè®¾å¤‡)  
          - **x86_64-unknown-linux-gnu** (x86_64, é€‚åˆPCå’Œè™šæ‹Ÿæœº)
          
          ## ğŸš€ å¿«é€Ÿå®‰è£…
          
          ### æ–¹æ³•1: ç›´æ¥ä¸‹è½½å®‰è£…
          ```bash
          # æ ¹æ®ä½ çš„è®¾å¤‡æ¶æ„é€‰æ‹©å¯¹åº”çš„å‘½ä»¤
          
          # ARM64 OpenWRT (æ¨è - é™æ€é“¾æ¥ï¼Œæ— ä¾èµ–)
          wget https://github.com/${{ github.repository }}/releases/download/v${{ github.run_number }}/websocket-at-gateway-aarch64-unknown-linux-musl.tar.gz
          
          # ARM64 æ ‡å‡†Linux (GNU libc)
          wget https://github.com/${{ github.repository }}/releases/download/v${{ github.run_number }}/websocket-at-gateway-aarch64-unknown-linux-gnu.tar.gz
          
          # ARMv7 (è€è®¾å¤‡)
          wget https://github.com/${{ github.repository }}/releases/download/v${{ github.run_number }}/websocket-at-gateway-armv7-unknown-linux-gnueabihf.tar.gz
          
          # x86_64 (PC/è™šæ‹Ÿæœº)
          wget https://github.com/${{ github.repository }}/releases/download/v${{ github.run_number }}/websocket-at-gateway-x86_64-unknown-linux-gnu.tar.gz
          
          # è§£å‹å¹¶å®‰è£…
          tar -xzf websocket-at-gateway-*.tar.gz
          scp websocket-at-gateway root@your-openwrt-ip:/usr/bin/
          ssh root@your-openwrt-ip "chmod +x /usr/bin/websocket-at-gateway"
          ```
          
          ### æ–¹æ³•2: ä½¿ç”¨Makefileå®‰è£…
          åœ¨æœ¬åœ°å…‹éš†ä»“åº“åï¼Œå¯ä»¥ç›´æ¥å®‰è£…åˆ°OpenWrtè®¾å¤‡:
          ```bash
          make install IP=192.168.1.1 ARCH=aarch64
          ```
          
          æ”¯æŒçš„æ¶æ„: `aarch64`, `armv7`, `x86_64`
          
          ## ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - OpenWrt æˆ–å…¶ä»–åŸºäºLinuxçš„ç³»ç»Ÿ
          - å¯¹åº”çš„CPUæ¶æ„æ”¯æŒ
          - è¶³å¤Ÿçš„å­˜å‚¨ç©ºé—´ (çº¦2-5MB)
          
          ## ğŸ”§ ç¼–è¯‘ä¿¡æ¯
          - ä¼˜åŒ–çº§åˆ«: å¤§å°ä¼˜åŒ– (`opt-level = "z"`)
          - é“¾æ¥æ—¶ä¼˜åŒ–: å¯ç”¨ (LTO)
          - ç¬¦å·å‰¥ç¦»: å¯ç”¨
          - æ–‡ä»¶å¤§å°: å·²ä¼˜åŒ–è‡³æœ€å°
        files: |
          artifacts/websocket-at-gateway-aarch64-unknown-linux-musl-release/websocket-at-gateway-aarch64-unknown-linux-musl.tar.gz
          artifacts/websocket-at-gateway-aarch64-unknown-linux-gnu-release/websocket-at-gateway-aarch64-unknown-linux-gnu.tar.gz
          artifacts/websocket-at-gateway-armv7-unknown-linux-gnueabihf-release/websocket-at-gateway-armv7-unknown-linux-gnueabihf.tar.gz
          artifacts/websocket-at-gateway-x86_64-unknown-linux-gnu-release/websocket-at-gateway-x86_64-unknown-linux-gnu.tar.gz
          ${{ steps.collect_ipk.outputs.files }}

  notify:
    needs: [build, deploy]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Notify deployment status
      run: |
        if [[ "${{ needs.build.result }}" == "success" && "${{ needs.deploy.result }}" == "success" ]]; then
          echo "âœ… æ„å»ºå’Œéƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ“¦ æ–°ç‰ˆæœ¬å·²å‘å¸ƒ: v${{ github.run_number }}"
          echo "ğŸ”— ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/v${{ github.run_number }}"
        else
          echo "âŒ æ„å»ºæˆ–éƒ¨ç½²å¤±è´¥"
          echo "è¯·æ£€æŸ¥GitHub Actionsæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
        fi
